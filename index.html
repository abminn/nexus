<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Required for YouTube Playables postMessage handshake -->
    <meta name="referrer" content="origin">
    <title>Nexus</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/gn-math/gn-math.github.io@main/favicon.png">
    
    <!-- CodeMirror Core -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/xml/xml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/css/css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/htmlmixed/htmlmixed.min.js"></script>
    
    <!-- CodeMirror Addons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closetag.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/xml-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchtags.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/search.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/search/searchcursor.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/addon/dialog/dialog.min.js"></script>
    
    <!-- Formatting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-html.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-beautify/1.14.7/beautify.min.js"></script>

    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.3.1",
        "react-dom": "https://esm.sh/react-dom@18.3.1",
        "react-dom/client": "https://esm.sh/react-dom@18.3.1/client"
      }
    }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&display=swap');
        
        :root {
            --bg-color: #020617;
            --accent-color: #8b5cf6;
            --accent-rgb: 139, 92, 246;
            --text-color: #f1f5f9;
            --glass-color: rgba(15, 23, 42, 0.7);
            --glow: 0 0 30px rgba(var(--accent-rgb), 0.3);
        }

        body.theme-amoled { --bg-color: #000000; --accent-color: #ffffff; --accent-rgb: 255, 255, 255; --glass-color: rgba(0, 0, 0, 0.85); --glow: 0 0 15px rgba(255, 255, 255, 0.2); }
        body.theme-cyber { --bg-color: #050505; --accent-color: #00ff41; --accent-rgb: 0, 255, 65; --glass-color: rgba(6, 15, 6, 0.8); --glow: 0 0 20px rgba(0, 255, 65, 0.4); }
        body.theme-rose { --bg-color: #1a0a0f; --accent-color: #fb7185; --accent-rgb: 251, 113, 133; --glass-color: rgba(45, 10, 20, 0.8); --glow: 0 0 25px rgba(251, 113, 133, 0.3); }
        body.theme-gold { --bg-color: #0c0a06; --accent-color: #fbbf24; --accent-rgb: 251, 191, 36; --glass-color: rgba(25, 20, 10, 0.8); --glow: 0 0 20px rgba(251, 191, 36, 0.3); }
        body.theme-admin-hellfire { --bg-color: #050000; --accent-color: #ff0000; --accent-rgb: 255, 0, 0; --glass-color: rgba(20, 0, 0, 0.9); --glow: 0 0 30px rgba(255, 0, 0, 0.6); }

        body { font-family: 'Space Grotesk', sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; transition: all 0.4s ease; overflow-x: hidden; }
        .animated-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 50% 50%, rgba(var(--accent-rgb), 0.1) 0%, var(--bg-color) 100%); }
        .glass { background: var(--glass-color); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); border: 1px solid rgba(var(--accent-rgb), 0.1); }
        .accent-text { color: var(--accent-color); }
        .accent-bg { background-color: var(--accent-color); }
        .accent-glow { box-shadow: var(--glow); }

        .game-card-hover { transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .game-card-hover:hover { transform: translateY(-5px) scale(1.02); box-shadow: 0 12px 30px -10px rgba(var(--accent-rgb), 0.4); border-color: var(--accent-color); }

        .visible-scroll { scrollbar-width: thin; scrollbar-color: var(--accent-color) rgba(255, 255, 255, 0.05); }
        .visible-scroll::-webkit-scrollbar { height: 6px; }
        .visible-scroll::-webkit-scrollbar-track { background: rgba(255, 255, 255, 0.05); border-radius: 10px; }
        .visible-scroll::-webkit-scrollbar-thumb { background: var(--accent-color); border-radius: 10px; }

        .section-header { border-left: 5px solid var(--accent-color); padding-left: 1rem; text-transform: uppercase; letter-spacing: 0.05em; }
        .badge { background: rgba(var(--accent-rgb), 0.9); backdrop-filter: blur(4px); padding: 1px 6px; border-radius: 4px; font-size: 8px; font-weight: 800; color: black; }
        @keyframes logoSpin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .logo-ring { border: 2px solid var(--accent-color); border-top-color: transparent; animation: logoSpin 4s linear infinite; }
        .modal-fade-in { animation: fadeIn 0.25s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        .sidebar-trigger { position: fixed; top: 0; left: 0; width: 60px; height: 100vh; z-index: 100; }
        .sidebar { position: fixed; top: 0; left: -280px; width: 260px; height: 100vh; z-index: 101; transition: all 0.4s cubic-bezier(0.19, 1, 0.22, 1); background: rgba(var(--accent-rgb), 0.05); backdrop-filter: blur(25px); border-right: 1px solid rgba(var(--accent-rgb), 0.1); box-shadow: 20px 0 50px -10px rgba(0, 0, 0, 0.5); }
        .sidebar-trigger:hover + .sidebar, .sidebar:hover { left: 0; }
        .sidebar-item { transition: all 0.25s ease; position: relative; overflow: hidden; display: flex; align-items: center; gap: 1rem; padding: 1rem 1.5rem; width: 100%; border-radius: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; font-size: 0.875rem; border: none; background: transparent; cursor: pointer; color: var(--text-color); }
        .sidebar-item:hover { background: rgba(var(--accent-rgb), 0.1); padding-left: 2rem; color: var(--accent-color); }
        .sidebar-item.active { background: rgba(var(--accent-rgb), 0.15); border-left: 4px solid var(--accent-color); color: var(--accent-color); text-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5); }
        .sidebar-icon { width: 20px; height: 20px; fill: currentColor; }

        .vault-section { display: flex; flex-direction: column; gap: 1.5rem; margin-bottom: 4rem; }
        .letter-header { display: flex; align-items: center; gap: 1rem; user-select: none; }
        .letter-circle { width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; background: rgba(var(--accent-rgb), 0.05); border: 1px solid rgba(var(--accent-rgb), 0.1); border-radius: 12px; font-size: 1.5rem; font-weight: 900; color: var(--accent-color); }
        .letter-line { flex: 1; height: 1px; background: linear-gradient(to right, rgba(var(--accent-rgb), 0.2), transparent); }

        .vault-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
        @media (min-width: 640px) { .vault-grid { grid-template-columns: repeat(3, 1fr); } }
        @media (min-width: 1024px) { .vault-grid { grid-template-columns: repeat(5, 1fr); } }
        @media (min-width: 1280px) { .vault-grid { grid-template-columns: repeat(6, 1fr); } }

        .CodeMirror { height: 500px !important; font-family: 'Fira Code', monospace; font-size: 14px; background: transparent !important; color: #fff !important; border-radius: 0 0 24px 24px; }
        .modified-dot { width: 6px; height: 6px; background: var(--accent-color); border-radius: 50%; display: inline-block; margin-left: 6px; box-shadow: 0 0 10px var(--accent-color); }
        .utility-card { aspect-ratio: 16/9; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; gap: 1rem; padding: 2rem; }
        
        .anime-container { width: 100%; height: calc(100vh - 120px); background: #000; border-radius: 24px; overflow: hidden; border: 2px solid rgba(var(--accent-rgb), 0.2); position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: var(--glow); transition: border-color 0.4s ease, box-shadow 0.4s ease; }
        .anime-iframe { width: 100%; height: 100%; border: none; background: #000; }

        .tab-button { padding: 0.5rem 1.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; transition: all 0.3s ease; border: 1px solid transparent; flex-shrink: 0; }
        .tab-button:hover { background: rgba(var(--accent-rgb), 0.1); }
        .tab-button.active { background: var(--accent-color); color: black; box-shadow: var(--glow); }
        .tab-button.active:hover { opacity: 0.9; }
    </style>
</head>
<body>
    <div class="animated-bg" id="star-field"></div>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, createElement, useMemo, useRef } from 'react';
        import ReactDOM from 'react-dom/client';

        const ZONES_URL = "https://cdn.jsdelivr.net/gh/gn-math/assets@main/zones.json";
        const COVER_BASE = "https://cdn.jsdelivr.net/gh/gn-math/covers@main";
        const HTML_BASE = "https://cdn.jsdelivr.net/gh/gn-math/html@main";

        const HOT_TITLES = ["Buckshot Roulette", "ULTRAKILL", "Pizza Tower", "R.E.P.O", "People Playground", "Sprunki", "WebFishing", "Blade Ball"];
        const FEATURED_POOL = ["Minecraft 1.21.4", "Geometry Dash Lite", "Retro Bowl", "Friday Night Funkin", "Happy Wheels", "Slope", "Papa's Freezeria", "Cookie Clicker", "Plants vs Zombies", "Retro Bowl College"];

        const THEMES = [
            { id: 'dark', name: 'Cosmic Dark', class: '' },
            { id: 'amoled', name: 'True Black', class: 'theme-amoled' },
            { id: 'cyber', name: 'Cyber Neon', class: 'theme-cyber' },
            { id: 'rose', name: 'Rose Nebula', class: 'theme-rose' },
            { id: 'gold', name: 'Golden Sun', class: 'theme-gold' }
        ];

        const GameIcon = () => createElement('svg', { className: 'sidebar-icon', viewBox: '0 0 24 24' },
            createElement('path', { d: 'M21,6H3C1.9,6,1,6.9,1,8v8c0,1.1,0.9,2,2,2h18c1.1,0,2-0.9,2-2V8C23,6.9,22.1,6,21,6z M18,15c-0.55,0-1-0.45-1-1s0.45-1,1-1s1,0.45,1,1S18.55,15,18,15z M20,12c-0.55,0-1-0.45-1-1s0.45-1,1-1s1,0.45,1,1S20.55,12,20,12z M11,13H9v2H8v-2H6v-1h2V10h1v2h2V13z' })
        );

        const UtilityIcon = () => createElement('svg', { className: 'sidebar-icon', viewBox: '0 0 24 24' },
            createElement('path', { d: 'M22.7,19l-9.1-9.1c0.9-2.3,0.4-5-1.5-6.9c-2-2-5-2.4-7.4-1.3L9,6.5L6.5,9L1.7,4.2c-1.1,2.4-0.7,5.4,1.3,7.4c1.9,1.9,4.5,2.4,6.9,1.5l9.1,9.1c0.4,0.4,1,0.4,1.4,0l2.3-2.3C23.1,19.9,23.1,19.3,22.7,19z' })
        );

        const AnimeIcon = () => createElement('svg', { className: 'sidebar-icon', viewBox: '0 0 24 24' },
            createElement('path', { d: 'M12,2L4.5,20.29L5.21,21L12,18L18.79,21L19.5,20.29L12,2M12,15.9L8.33,18.5L12,9.65L15.67,18.5L12,15.9Z' })
        );

        const GameCard = ({ zone, variant = 'normal', onClick, isSpotlight = false }) => {
            const isHot = HOT_TITLES.includes(zone.name);
            const sizeClasses = { hero: 'aspect-square w-full h-full', wide: 'aspect-video w-full', normal: 'aspect-[3/4] w-full', carousel: 'aspect-[3/4] w-[160px] flex-shrink-0', vault: 'aspect-[3/4] w-full' };
            const coverSrc = zone.isLocal ? 'https://cdn.jsdelivr.net/gh/gn-math/assets@main/local_game_cover.png' : (zone.cover ? zone.cover.replace("{COVER_URL}", COVER_BASE) : '');

            return createElement('div', { onClick, className: `group relative glass rounded-xl overflow-hidden cursor-pointer game-card-hover border border-white/5 ${sizeClasses[variant]}` },
                createElement('img', { src: coverSrc, className: 'w-full h-full object-cover transition-transform duration-700 group-hover:scale-110', loading: 'lazy' }),
                createElement('div', { className: 'absolute inset-0 bg-gradient-to-t from-black via-black/10 to-transparent' }),
                createElement('div', { className: 'absolute top-2 left-2 flex gap-1' },
                    isHot && createElement('span', { className: 'badge' }, 'ðŸ”¥'),
                    isSpotlight && createElement('span', { className: 'badge !bg-yellow-400 !text-black shadow-lg' }, 'â­'),
                    zone.isLocal && createElement('span', { className: 'badge !bg-blue-500' }, 'LOCAL')
                ),
                createElement('div', { className: 'absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-300' },
                    createElement('div', { className: 'w-10 h-10 accent-bg accent-glow rounded-full flex items-center justify-center scale-90 group-hover:scale-100 transition-transform' },
                        createElement('svg', { viewBox: "0 0 24 24", className: "w-6 h-6 text-black ml-0.5", fill: "currentColor" }, createElement('path', { d: "M8 5v14l11-7z" }))
                    )
                ),
                createElement('div', { className: 'absolute bottom-0 left-0 right-0 p-3' },
                    createElement('p', { className: `font-bold truncate text-white uppercase italic ${variant === 'hero' ? 'text-lg' : 'text-[11px]'}` }, zone.name)
                )
            );
        };

        const IDE = ({ onDeploy, onClose }) => {
            const editorHostRef = useRef(null);
            const cmInstance = useRef(null);
            const [isModified, setIsModified] = useState(false);
            const template = `<!-- Nexus IDE v5.0 -->\n<div class="container">\n    <h1>New Project</h1>\n</div>\n<style>\n  .container { font-family: sans-serif; text-align: center; color: #8b5cf6; padding-top: 50px; }\n</style>`;

            useEffect(() => {
                if (!editorHostRef.current) return;
                const editor = CodeMirror(editorHostRef.current, {
                    value: template, mode: "htmlmixed", theme: "dracula", lineNumbers: true,
                    autoCloseTags: true, autoCloseBrackets: true, matchTags: { bothTags: true }, matchBrackets: true,
                    foldGutter: true, gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"], lineWrapping: true
                });
                cmInstance.current = editor;
                editor.on("change", () => setIsModified(true));
                return () => { if (cmInstance.current) { const w = cmInstance.current.getWrapperElement(); if(w && w.parentNode) w.parentNode.removeChild(w); } };
            }, []);

            return createElement('div', { className: 'fixed inset-0 z-[150] bg-black/80 backdrop-blur-xl flex items-center justify-center p-6' },
                createElement('div', { className: 'glass w-full max-w-6xl rounded-3xl border border-white/10 overflow-hidden flex flex-col modal-fade-in h-[85vh]' },
                    createElement('div', { className: 'bg-white/5 p-4 border-b border-white/10 flex justify-between items-center' },
                        createElement('span', { className: 'text-[10px] font-black uppercase tracking-widest' }, 'workspace.html'),
                        createElement('div', { className: 'flex gap-2' },
                            createElement('button', { onClick: () => onDeploy(cmInstance.current.getValue()), className: 'accent-bg text-black px-4 py-1.5 rounded-lg text-[10px] font-black uppercase' }, 'Deploy'),
                            createElement('button', { onClick: onClose, className: 'bg-red-500/10 text-red-500 px-4 py-1.5 rounded-lg text-[10px] font-black uppercase' }, 'Close')
                        )
                    ),
                    createElement('div', { ref: editorHostRef, className: 'flex-1 overflow-hidden' })
                )
            );
        };

        const SettingsModal = ({ onClose, currentTheme, onThemeChange, currentCloak, onCloakChange }) => (
            createElement('div', { className: 'fixed inset-0 z-[200] flex items-center justify-center p-4 bg-black/75 backdrop-blur-sm', onClick: onClose },
                createElement('div', { className: 'glass w-full max-w-md p-8 rounded-3xl modal-fade-in flex flex-col gap-6', onClick: e => e.stopPropagation() },
                    createElement('div', { className: 'flex justify-between items-center' },
                        createElement('h2', { className: 'text-2xl font-black italic tracking-tighter' }, 'SYSTEM CONFIG'),
                        createElement('button', { onClick: onClose, className: 'text-slate-500 hover:text-white' }, 'âœ•')
                    ),
                    createElement('div', { className: 'space-y-3' },
                        createElement('h3', { className: 'text-[10px] font-bold accent-text uppercase tracking-widest' }, 'Tab Cloaking'),
                        createElement('input', { type: 'text', value: currentCloak, onChange: (e) => onCloakChange(e.currentTarget.value), placeholder: 'Tab Title', className: 'w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-accent-color transition-all' })
                    ),
                    createElement('div', { className: 'space-y-3' },
                        createElement('h3', { className: 'text-[10px] font-bold accent-text uppercase tracking-widest' }, 'Appearance'),
                        createElement('div', { className: 'grid grid-cols-2 gap-2' },
                            THEMES.map(theme => createElement('button', { key: theme.id, onClick: () => onThemeChange(theme.id), className: `p-3 rounded-lg border text-xs font-bold transition-all ${currentTheme === theme.id ? 'accent-bg text-black' : 'border-white/5 bg-white/5'}` }, theme.name))
                        )
                    ),
                    createElement('button', { onClick: onClose, className: 'accent-bg w-full py-3 rounded-xl font-black text-black text-sm uppercase' }, 'Done')
                )
            )
        );

        const GamePlayer = ({ zone, onClose, isAdminActive }) => {
            const [isLoading, setIsLoading] = useState(true);
            const [playerUrl, setPlayerUrl] = useState('');
            const containerRef = useRef(null);

            useEffect(() => {
                const resolveAndLoad = async () => {
                    setIsLoading(true);
                    let finalUrl = zone.url;
                    if (!zone.isLocal && !zone.isIDE) finalUrl = zone.url.replace("{HTML_URL}", HTML_BASE);

                    const isYouTube = finalUrl.includes("youtube.com") || finalUrl.includes("youtu.be") || zone.isYouTube;
                    const isUnity = zone.isUnity || finalUrl.includes("UnityBuild") || finalUrl.includes("loader.js");
                    const isSingleHtml = finalUrl.endsWith(".html") && !isUnity && !isYouTube && !zone.isLocal && !zone.isIDE;

                    if (isYouTube) {
                        const origin = encodeURIComponent(window.location.origin);
                        const sep = finalUrl.includes("?") ? "&" : "?";
                        setPlayerUrl(`${finalUrl}${sep}origin=${origin}`);
                    } else if (isSingleHtml) {
                        try {
                            const res = await fetch(finalUrl);
                            const html = await res.text();
                            const blob = new Blob([html], { type: "text/html" });
                            setPlayerUrl(URL.createObjectURL(blob));
                        } catch (e) { setPlayerUrl(finalUrl); }
                    } else {
                        setPlayerUrl(finalUrl);
                    }
                };
                resolveAndLoad();
            }, [zone.url, zone.isLocal, zone.isIDE, zone.isUnity, zone.isYouTube]);

            useEffect(() => {
                if (!playerUrl) return;
                const t = setTimeout(() => setIsLoading(false), 4500);
                return () => clearTimeout(t);
            }, [playerUrl]);

            return createElement('div', { className: `fixed inset-0 z-[120] bg-black flex flex-col ${isAdminActive ? 'top-[42px]' : 'top-0'}` },
                createElement('header', { className: 'glass px-4 py-2 flex items-center justify-between border-b border-white/10' },
                    createElement('span', { className: 'accent-text font-black text-xs uppercase' }, zone.name),
                    createElement('div', { className: 'flex gap-2' },
                        createElement('button', { onClick: () => containerRef.current?.requestFullscreen(), className: 'px-3 py-1.5 glass rounded-lg text-[9px] font-bold uppercase hover:bg-white/10' }, 'Capture FS'),
                        createElement('button', { onClick: onClose, className: 'px-3 py-1.5 bg-red-500/10 text-red-500 rounded-lg text-[10px] font-bold uppercase' }, 'Exit')
                    )
                ),
                createElement('div', { ref: containerRef, className: 'flex-1 relative bg-black' },
                    isLoading && createElement('div', { className: 'absolute inset-0 flex items-center justify-center' }, createElement('div', { className: 'w-8 h-8 border-4 border-accent-color/20 border-t-accent-color rounded-full animate-spin' })),
                    playerUrl && createElement('iframe', { 
                        src: playerUrl, onLoad: () => setIsLoading(false),
                        className: `w-full h-full border-none ${isLoading ? 'opacity-0' : 'opacity-100'}`,
                        allow: "fullscreen *; autoplay; gamepad; microphone; camera; midi; encrypted-media; cross-origin-isolated",
                        allowFullScreen: true
                    })
                )
            );
        };

        const App = () => {
            const [zones, setZones] = useState([]);
            const [search, setSearch] = useState("");
            const [activeZone, setActiveZone] = useState(null);
            const [currentTheme, setCurrentTheme] = useState('dark');
            const [cloakTitle, setCloakTitle] = useState('Nexus');
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('games');
            const [gamesTab, setGamesTab] = useState('all'); // 'all', 'standard', 'unity', 'playables'
            const [showIDE, setShowIDE] = useState(false);
            const fileRef = useRef(null);
            const animeContainerRef = useRef(null);
            const [unityZones, setUnityZones] = useState([]);
            const [playableZones, setPlayableZones] = useState([]);
            const [standardZones, setStandardZones] = useState([]);

            const detectGameType = async (zone) => {
                const url = zone.url.replace("{HTML_URL}", HTML_BASE).toLowerCase();

                // 1. Explicit flags
                if (zone.isUnity) return "unity";
                if (zone.isYouTube) return "playable";

                // 2. URL Pattern matching
                if (
                    url.includes("youtube-playables") ||
                    url.includes("ytgame") ||
                    url.includes("playables") ||
                    url.includes("playables.youtube.com")
                ) return "playable";

                if (
                    url.endsWith("loader.js") ||
                    url.includes("build.framework.js") ||
                    url.includes("build.wasm") ||
                    url.includes("build.data") ||
                    url.includes("/build/") ||
                    url.includes("/builds/")
                ) return "unity";

                // 3. Content Sniffing (Experimental)
                if (url.endsWith(".html")) {
                    try {
                        const controller = new AbortController();
                        const t = setTimeout(() => controller.abort(), 1500);
                        const res = await fetch(url, { signal: controller.signal });
                        clearTimeout(t);
                        const text = (await res.text()).toLowerCase();

                        if (text.includes("unityinstance") && text.includes("webgl"))
                            return "unity";

                        if (
                            text.includes("ytgame.js") ||
                            text.includes("youtube playables") ||
                            (text.includes("postmessage") && text.includes("origin")) ||
                            (text.includes('meta name="referrer"') && text.includes("origin"))
                        )
                            return "playable";
                    } catch (e) {}
                }

                return "normal";
            };

            useEffect(() => { 
                const fetchAndClassify = async () => {
                    try {
                        const r = await fetch(ZONES_URL);
                        const data = await r.json();
                        
                        const unity = [];
                        const playables = [];
                        const standard = [];
                        
                        await Promise.all(data.map(async (z) => {
                            const type = await detectGameType(z);

                            if (type === "unity") {
                                z.isUnity = true;
                                unity.push(z);
                            } else if (type === "playable") {
                                z.isYouTube = true;
                                playables.push(z);
                            } else {
                                standard.push(z);
                            }
                        }));
                        
                        setZones(data);
                        setUnityZones(unity);
                        setPlayableZones(playables);
                        setStandardZones(standard);
                    } catch(e) { 
                        console.error("Detection error:", e);
                        setZones([]); 
                    }
                };
                fetchAndClassify();
            }, []);

            useEffect(() => { document.title = cloakTitle; document.body.className = (THEMES.find(t => t.id === currentTheme)?.class || ''); }, [currentTheme, cloakTitle]);

            // DYNAMIC SPOTLIGHT LOGIC
            const spotlightGames = useMemo(() => {
                if (!zones || zones.length === 0) return { hero: null, wide: [], grid: [], hot: [] };
                
                const today = new Date().toISOString().split('T')[0];
                const seedStr = today.split('-').join('');
                let seedValue = parseInt(seedStr);

                const seededRandom = () => {
                    const x = Math.sin(seedValue++) * 10000;
                    return x - Math.floor(x);
                };

                const pool = zones.filter(z => FEATURED_POOL.includes(z.name));
                const hotPool = zones.filter(z => HOT_TITLES.includes(z.name));
                
                const shuffled = [...pool].sort(() => seededRandom() - 0.5);
                const shuffledHot = [...hotPool].sort(() => seededRandom() - 0.5);

                return {
                    hero: shuffled[0] || (zones[0] || null),
                    wide: shuffled.slice(1, 3) || [],
                    grid: shuffled.slice(3, 9) || [],
                    hot: shuffledHot || []
                };
            }, [zones]);

            const filteredAndGrouped = useMemo(() => {
                if (!zones) return { alpha: [] };
                
                let basePool = zones;
                if (gamesTab === 'standard') basePool = standardZones;
                else if (gamesTab === 'unity') basePool = unityZones;
                else if (gamesTab === 'playables') basePool = playableZones;

                let results = basePool.filter(z => z.name.toLowerCase().includes(search.toLowerCase()));
                
                const alpha = {};
                results.forEach(z => { let char = z.name[0].toUpperCase(); if (/[0-9]/.test(char)) char = '#'; if (!alpha[char]) alpha[char] = []; alpha[char].push(z); });
                return { 
                    alpha: Object.keys(alpha).sort().map(k => ({ char: k, games: alpha[k] })) 
                };
            }, [zones, search, gamesTab, unityZones, playableZones, standardZones]);

            return createElement('div', { className: 'min-h-screen flex flex-col' },
                createElement('div', { className: 'sidebar-trigger' }),
                createElement('aside', { className: 'sidebar flex flex-col p-6 gap-8' },
                    createElement('div', { className: 'flex items-center gap-3 mb-6' }, createElement('div', { className: 'w-10 h-10 accent-bg rounded-xl flex items-center justify-center text-black font-black text-xl accent-glow' }, 'N'), createElement('span', { className: 'font-black italic text-xl tracking-tighter' }, 'NEXUS')),
                    createElement('nav', { className: 'flex-1 flex flex-col gap-3' },
                        createElement('button', { onClick: () => setActiveTab('games'), className: `sidebar-item ${activeTab === 'games' ? 'active' : ''}` }, createElement(GameIcon), 'Games'),
                        createElement('button', { onClick: () => setActiveTab('anime'), className: `sidebar-item ${activeTab === 'anime' ? 'active' : ''}` }, createElement(AnimeIcon), 'Anime'),
                        createElement('button', { onClick: () => setActiveTab('utilities'), className: `sidebar-item ${activeTab === 'utilities' ? 'active' : ''}` }, createElement(UtilityIcon), 'Utilities')
                    )
                ),
                createElement('header', { className: 'glass sticky top-0 z-[60] px-6 py-4 border-b border-white/5 flex items-center justify-between' },
                    createElement('div', { className: 'flex items-center gap-4' },
                        createElement('div', { className: 'relative w-12 h-12 flex items-center justify-center' }, createElement('div', { className: 'absolute inset-0 logo-ring rounded-full' }), createElement('div', { className: 'accent-bg accent-glow w-6 h-6 rounded-lg flex items-center justify-center text-black font-black text-[10px] z-10' }, 'N')),
                        createElement('h1', { className: 'text-2xl font-black italic tracking-tighter text-white' }, 'Nexus')
                    ),
                    createElement('div', { className: 'flex items-center gap-3' },
                        createElement('input', { className: 'w-64 px-5 py-2.5 rounded-xl bg-white/5 border border-white/10 text-white text-sm', placeholder: 'Search...', value: search, onChange: e => setSearch(e.target.value) }),
                        createElement('button', { onClick: () => setIsSettingsOpen(true), className: 'p-2.5 glass rounded-xl hover:bg-white/10' }, 'âš™ï¸')
                    )
                ),
                createElement('main', { className: 'max-w-[90rem] mx-auto w-full py-12 px-6 space-y-24' },
                    activeTab === 'games' ? (
                        createElement(React.Fragment, null,
                            // Sub-tabs for Games
                            createElement('div', { className: 'flex items-center gap-2 pb-2 mb-8 border-b border-white/5 overflow-x-auto visible-scroll' },
                                createElement('button', { onClick: () => setGamesTab('all'), className: `tab-button ${gamesTab === 'all' ? 'active' : ''}` }, 'All'),
                                createElement('button', { onClick: () => setGamesTab('standard'), className: `tab-button ${gamesTab === 'standard' ? 'active' : ''}` }, 'Standard'),
                                createElement('button', { onClick: () => setGamesTab('unity'), className: `tab-button relative ${gamesTab === 'unity' ? 'active' : ''}` }, 
                                    'Unity',
                                    createElement('span', { className: 'absolute -top-1 -right-2 badge !bg-red-500/80 !text-white' }, 'âš ï¸ Issues')
                                ),
                                createElement('button', { onClick: () => setGamesTab('playables'), className: `tab-button relative ${gamesTab === 'playables' ? 'active' : ''}` }, 
                                    'Playables',
                                    createElement('span', { className: 'absolute -top-1 -right-2 badge !bg-yellow-500/80 !text-black' }, 'âš ï¸ unstable')
                                )
                            ),

                            !search && gamesTab === 'all' && spotlightGames.hero && createElement('section', { className: 'space-y-8' },
                                createElement('h2', { className: 'section-header text-xl font-black italic' }, 'Daily Spotlight'),
                                createElement('div', { className: 'grid grid-cols-1 md:grid-cols-12 gap-4' },
                                    createElement('div', { className: 'md:col-span-6' }, createElement(GameCard, { variant: 'hero', zone: spotlightGames.hero, onClick: () => setActiveZone(spotlightGames.hero), isSpotlight: true })),
                                    createElement('div', { className: 'md:col-span-6 flex flex-col gap-4' }, (spotlightGames.wide || []).map(g => createElement(GameCard, { key: g.id, variant: 'wide', zone: g, onClick: () => setActiveZone(g), isSpotlight: true }))),
                                    createElement('div', { className: 'md:col-span-12 grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-6 gap-4' }, (spotlightGames.grid || []).map(g => createElement(GameCard, { key: g.id, zone: g, onClick: () => setActiveZone(g), isSpotlight: true })))
                                )
                            ),
                            !search && gamesTab === 'all' && (spotlightGames.hot || []).length > 0 && createElement('section', { className: 'space-y-4' },
                                createElement('h2', { className: 'section-header text-xl font-black italic' }, 'Hot Right Now'),
                                createElement('div', { className: 'flex gap-4 overflow-x-auto pb-4 visible-scroll snap-x' },
                                    (spotlightGames.hot || []).map(g => createElement('div', { key: g.id, className: 'snap-start' }, createElement(GameCard, { variant: 'carousel', zone: g, onClick: () => setActiveZone(g) })))
                                )
                            ),
                            createElement('section', { className: 'space-y-10' }, 
                                filteredAndGrouped.alpha.length > 0 ? (filteredAndGrouped.alpha || []).map(block => createElement('div', { key: block.char, className: 'vault-section' },
                                    createElement('div', { className: 'letter-header' }, createElement('div', { className: 'letter-circle' }, block.char), createElement('div', { className: 'letter-line' })),
                                    createElement('div', { className: 'vault-grid' }, (block.games || []).map(g => createElement(GameCard, { key: g.id, variant: 'vault', zone: g, onClick: () => setActiveZone(g) })))
                                )) : (
                                    createElement('div', { className: 'py-20 text-center opacity-40 italic' }, 'No matches found for this category.')
                                )
                            )
                        )
                    ) : activeTab === 'anime' ? (
                        createElement('section', { className: 'space-y-8 h-full' },
                            createElement('div', { className: 'flex justify-between items-center' },
                                createElement('div', { className: 'flex flex-col' },
                                    createElement('h2', { className: 'section-header text-xl font-black italic' }, 'Anime Portal'),
                                    createElement('span', { className: 'text-[9px] accent-text font-bold uppercase tracking-[0.2em] mt-1' }, 'Nebula Sync Active')
                                ),
                                createElement('div', { className: 'flex gap-3' },
                                    createElement('button', { onClick: () => animeContainerRef.current?.requestFullscreen(), className: 'p-2.5 glass rounded-xl hover:bg-white/10 text-xs font-bold uppercase tracking-widest flex items-center gap-2' }, 
                                        createElement('svg', { className: 'w-4 h-4', fill: 'currentColor', viewBox: '0 0 24 24' }, createElement('path', { d: 'M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z' })),
                                        'Fullscreen'
                                    ),
                                    createElement('span', { className: 'badge !bg-green-500 !text-black flex items-center' }, 'ONLINE')
                                )
                            ),
                            createElement('div', { ref: animeContainerRef, className: 'anime-container' },
                                createElement('iframe', { 
                                    src: "https://hianime.to",
                                    className: "anime-iframe",
                                    sandbox: "allow-forms allow-scripts allow-same-origin allow-downloads",
                                    allow: "fullscreen"
                                }),
                                createElement('div', { className: 'absolute inset-0 z-[-1] flex flex-col items-center justify-center p-12 text-center opacity-50' },
                                    createElement('h3', { className: 'text-2xl font-black mb-4' }, 'CONNECTION RESTRICTED'),
                                    createElement('p', { className: 'text-sm max-w-md' }, 'HiAnime often restricts embedding due to security policies. If the frame above is empty, the external site has blocked the connection.')
                                )
                            )
                        )
                    ) : (
                        createElement('section', { className: 'space-y-12' },
                            createElement('div', { className: 'grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto' },
                                createElement('div', { onClick: () => setShowIDE(true), className: 'group utility-card glass rounded-3xl cursor-pointer game-card-hover border border-white/5 relative overflow-hidden' },
                                    createElement('div', { className: 'w-16 h-16 glass rounded-2xl flex items-center justify-center text-3xl mb-4' }, 'ðŸ› ï¸'),
                                    createElement('h3', { className: 'text-xl font-black uppercase italic' }, 'IDE Workspace')
                                ),
                                createElement('div', { onClick: () => fileRef.current?.click(), className: 'group utility-card glass rounded-3xl cursor-pointer game-card-hover border border-white/5 relative overflow-hidden' },
                                    createElement('input', { type: 'file', ref: fileRef, accept: '.html', className: 'hidden', onChange: e => e.target.files[0] && setActiveZone({ name: e.target.files[0].name, url: URL.createObjectURL(e.target.files[0]), isLocal: true }) }),
                                    createElement('div', { className: 'w-16 h-16 glass rounded-2xl flex items-center justify-center text-3xl mb-4' }, 'ðŸ“‚'),
                                    createElement('h3', { className: 'text-xl font-black uppercase italic' }, 'Local Upload')
                                )
                            )
                        )
                    )
                ),
                showIDE && createElement(IDE, { onClose: () => setShowIDE(false), onDeploy: (code) => setActiveZone({ name: 'IDE Preview', url: URL.createObjectURL(new Blob([code], {type: 'text/html'})), isIDE: true }) }),
                activeZone && createElement(GamePlayer, { zone: activeZone, onClose: () => setActiveZone(null) }),
                isSettingsOpen && createElement(SettingsModal, { onClose: () => setIsSettingsOpen(false), currentTheme, onThemeChange: setCurrentTheme, currentCloak: cloakTitle, onCloakChange: setCloakTitle })
            );
        };

        const rootElement = document.getElementById('root');
        if (rootElement) {
            const root = ReactDOM.createRoot(rootElement);
            root.render(createElement(App));
        }
    </script>
</body>
</html>